<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Irrigation Dashboard</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      header {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        margin-bottom: 30px;
        text-align: center;
      }

      h1 {
        color: #667eea;
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .status-badge {
        display: inline-block;
        padding: 8px 20px;
        border-radius: 20px;
        font-weight: bold;
        margin-top: 10px;
      }

      .status-online {
        background: #10b981;
        color: white;
      }

      .status-offline {
        background: #ef4444;
        color: white;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        transition: transform 0.3s ease;
      }

      .card:hover {
        transform: translateY(-5px);
      }

      .card-header {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
      }

      .card-icon {
        font-size: 2em;
        margin-right: 15px;
      }

      .card-title {
        font-size: 1.3em;
        color: #333;
        font-weight: 600;
      }

      .sensor-value {
        font-size: 3em;
        font-weight: bold;
        color: #667eea;
        margin: 20px 0;
      }

      .sensor-label {
        color: #666;
        font-size: 0.9em;
        margin-top: 10px;
      }

      .status-indicator {
        display: inline-block;
        padding: 10px 20px;
        border-radius: 25px;
        font-weight: bold;
        font-size: 1.1em;
        margin-top: 15px;
      }

      .status-yes {
        background: #10b981;
        color: white;
      }

      .status-no {
        background: #ef4444;
        color: white;
      }

      .status-on {
        background: #3b82f6;
        color: white;
      }

      .status-off {
        background: #6b7280;
        color: white;
      }

      .status-manual-on {
        background: #8b5cf6;
        color: white;
      }

      .status-manual-off {
        background: #ec4899;
        color: white;
      }

      .status-cooldown {
        background: #f59e0b;
        color: white;
      }

      .status-watering {
        background: #06b6d4;
        color: white;
      }

      .control-panel {
        background: white;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        margin-bottom: 30px;
      }

      .control-buttons {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        margin-top: 20px;
      }

      .btn {
        flex: 1;
        min-width: 150px;
        padding: 15px 30px;
        border: none;
        border-radius: 10px;
        font-size: 1.1em;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        position: relative;
      }

      .btn:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .btn-auto {
        background: #10b981;
        color: white;
      }

      .btn-on {
        background: #8b5cf6;
        color: white;
      }

      .btn-off {
        background: #ef4444;
        color: white;
      }

      .btn.active {
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.5);
        transform: scale(1.08);
      }

      .progress-bar {
        width: 100%;
        height: 30px;
        background: #f0f0f0;
        border-radius: 15px;
        overflow: hidden;
        margin-top: 15px;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        transition: width 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
      }

      .timestamp {
        text-align: center;
        color: white;
        margin-top: 20px;
        font-size: 0.9em;
      }

      .cooldown-timer {
        font-size: 1.8em;
        color: #f59e0b;
        font-weight: bold;
        margin-top: 10px;
      }

      .analytics-box {
        background: #f9fafb;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
        text-align: center;
        transition: transform 0.25s ease;
      }

      .analytics-box:hover {
        transform: translateY(-5px);
      }

      .analytics-label {
        font-size: 0.9em;
        color: #666;
        margin-bottom: 8px;
      }

      .analytics-value {
        font-size: 1.8em;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 8px;
      }

      .analytics-status {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: bold;
      }

      .badge-good {
        background: #10b981;
        color: white;
      }

      .badge-warning {
        background: #f59e0b;
        color: white;
      }

      .badge-danger {
        background: #ef4444;
        color: white;
      }

      .badge-info {
        background: #3b82f6;
        color: white;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <header>
        <h1>üå± Smart Irrigation System</h1>
        <div class="status-badge status-offline" id="connectionStatus">
          Connecting...
        </div>
      </header>

      <!-- CONTROL PANEL -->
      <div class="control-panel">
        <h2 style="margin-bottom: 10px">Pump Control</h2>

        <div class="control-buttons">
          <button
            class="btn btn-auto"
            id="btnAuto"
            onclick="setPumpMode('AUTO')"
          >
            ü§ñ Auto Mode
          </button>

          <button
            class="btn btn-on"
            id="btnOn"
            onclick="setPumpMode('FORCE_ON')"
          >
            üü£ Force ON
          </button>

          <button
            class="btn btn-off"
            id="btnOff"
            onclick="setPumpMode('FORCE_OFF')"
          >
            üî¥ Force OFF
          </button>
        </div>
      </div>

      <!-- ANALYTICS SECTION -->
      <div class="card" style="margin-bottom: 30px">
        <div class="card-header">
          <div class="card-icon">üìä</div>
          <div class="card-title">System Analytics</div>
        </div>

        <div
          class="analytics-grid"
          style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 10px;
          "
        >
          <!-- Soil Moisture -->
          <div class="analytics-box">
            <div class="analytics-label">Soil Moisture</div>
            <div class="analytics-value" id="analyticsSoil">---</div>
            <div class="analytics-status" id="analyticsSoilStatus">---</div>
          </div>

          <!-- Water Tank -->
          <div class="analytics-box">
            <div class="analytics-label">Water Tank Level</div>
            <div class="analytics-value" id="analyticsWater">---</div>
            <div class="analytics-status" id="analyticsWaterStatus">---</div>
          </div>

          <!-- Rain Probability -->
          <div class="analytics-box">
            <div class="analytics-label">Rain Indicator</div>
            <div class="analytics-value" id="analyticsRain">---</div>
            <div class="analytics-status" id="analyticsRainStatus">---</div>
          </div>

          <!-- Pump Usage -->
          <div class="analytics-box">
            <div class="analytics-label">Pump</div>
            <div class="analytics-value" id="analyticsPumpUsage">---</div>
            <div class="analytics-status" id="analyticsPumpStatus">---</div>
          </div>
        </div>
      </div>

      <!-- GRID OF SENSOR/STATE CARDS -->
      <div class="grid">
        <!-- SYSTEM STATE -->
        <div class="card">
          <div class="card-header">
            <div class="card-icon">üîß</div>
            <div class="card-title">System State</div>
          </div>

          <div class="sensor-value" id="systemState" style="font-size: 2em">
            ---
          </div>

          <div class="sensor-label">Current Irrigation State</div>

          <div class="status-indicator" id="stateIndicator">---</div>

          <div class="cooldown-timer" id="cooldownTimer" style="display: none">
            ‚è±Ô∏è <span id="cooldownValue">0</span>s
          </div>
        </div>

        <!-- SOIL MOISTURE -->
        <div class="card">
          <div class="card-header">
            <div class="card-icon">üåæ</div>
            <div class="card-title">Soil Moisture</div>
          </div>

          <div class="sensor-value" id="soilADC">---</div>

          <div class="sensor-label">ADC Value</div>

          <div class="progress-bar">
            <div class="progress-fill" id="soilProgress">0%</div>
          </div>

          <div class="status-indicator" id="soilStatus">---</div>
        </div>

        <!-- WATER LEVEL -->
        <div class="card">
          <div class="card-header">
            <div class="card-icon">üíß</div>
            <div class="card-title">Water Tank</div>
          </div>

          <div class="sensor-value" id="waterADC">---</div>

          <div class="sensor-label">ADC Value</div>

          <div class="progress-bar">
            <div class="progress-fill" id="waterProgress">0%</div>
          </div>

          <div class="status-indicator" id="waterStatus">---</div>
        </div>

        <!-- RAIN SENSOR -->
        <div class="card">
          <div class="card-header">
            <div class="card-icon">üåßÔ∏è</div>
            <div class="card-title">Rain Sensor</div>
          </div>

          <div class="sensor-value" id="rainADC">---</div>

          <div class="sensor-label">ADC Value</div>

          <div class="progress-bar">
            <div class="progress-fill" id="rainProgress">0%</div>
          </div>

          <div class="status-indicator" id="rainStatus">---</div>
        </div>

        <!-- PUMP -->
        <div class="card">
          <div class="card-header">
            <div class="card-icon">‚ö°</div>
            <div class="card-title">Pump</div>
          </div>

          <div class="sensor-value" id="pumpStatus">---</div>

          <div class="sensor-label">Pump State</div>

          <div class="status-indicator" id="pumpIndicator">---</div>
        </div>

        <!-- REFILL -->
        <div class="card">
          <div class="card-header">
            <div class="card-icon">üö∞</div>
            <div class="card-title">Tank Refill</div>
          </div>

          <div class="sensor-value" id="refillStatus">---</div>

          <div class="sensor-label">Valve State</div>

          <div class="status-indicator" id="refillIndicator">---</div>
        </div>
      </div>

      <div
        style="
          display: flex;
          flex-direction: row;
          align-items: center;

          justify-content: center;
        "
      >
        <div
          style="
            color: white;
            margin-top: 20px;
            font-size: 0.9em;
            margin-right: 20px;
          "
        >
          Created By: 00016180
        </div>
        <div class="timestamp" id="lastUpdate">Last Updated: Never</div>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
      // Firebase Config
      const firebaseConfig = {
        apiKey: 'AIzaSyCdcaKw3zo9K4lflgq5j9t7hDFsH1S0D94',
        authDomain: 'fir-auth-3de38.firebaseapp.com',
        databaseURL: 'https://fir-auth-3de38-default-rtdb.firebaseio.com',
        projectId: 'fir-auth-3de38',
        storageBucket: 'fir-auth-3de38.firebasestorage.app',
        messagingSenderId: '1023229306904',
        appId: '1:1023229306904:web:ea23531d5a98fd5f573b6d',
      }

      firebase.initializeApp(firebaseConfig)
      const db = firebase.database()
      const ref = db.ref('smart_irrigation')

      const connectedRef = db.ref('.info/connected')
      connectedRef.on('value', (snap) => {
        const statusEl = document.getElementById('connectionStatus')
        if (snap.val() === true) {
          statusEl.textContent = 'Online'
          statusEl.className = 'status-badge status-online'
        } else {
          statusEl.textContent = 'Offline'
          statusEl.className = 'status-badge status-offline'
        }
      })
      //----------------------------------------------------
      // UI UPDATE
      //----------------------------------------------------
      ref.on('value', (snap) => {
        const d = snap.val()
        if (!d) return

        // --- SYSTEM STATE ---
        const stateEl = document.getElementById('systemState')
        const stateIndicator = document.getElementById('stateIndicator')
        const cooldownTimer = document.getElementById('cooldownTimer')

        let txt = d.state || '---'
        let cls = 'status-off'

        switch (d.state) {
          case 'MANUAL_ON':
            txt = 'üü£ MANUAL ON'
            cls = 'status-manual-on'
            cooldownTimer.style.display = 'none'
            break

          case 'MANUAL_OFF':
            txt = 'üî¥ MANUAL OFF'
            cls = 'status-manual-off'
            cooldownTimer.style.display = 'none'
            break

          case 'WATERING':
            txt = 'üí¶ WATERING'
            cls = 'status-watering'
            cooldownTimer.style.display = 'none'
            break

          case 'WAITING_SOIL_ABSORB':
            txt = '‚è≥ WAITING SOIL TO ABSORB'
            cls = 'status-cooldown'
            cooldownTimer.style.display = 'block'
            break

          case 'RAINING':
            txt = 'üåßÔ∏è RAINING'
            cls = 'status-on'
            cooldownTimer.style.display = 'none'
            break

          case 'TANK_EMPTY':
            txt = 'üö® TANK EMPTY'
            cls = 'status-no'
            cooldownTimer.style.display = 'none'
            break

          case 'AUTO_READY':
            txt = '‚úÖ READY'
            cls = 'status-yes'
            cooldownTimer.style.display = 'none'
            break
        }

        stateEl.textContent = txt
        stateIndicator.textContent = txt
        stateIndicator.className = 'status-indicator ' + cls

        if (d.cooldown_remaining !== undefined) {
          document.getElementById('cooldownValue').textContent =
            d.cooldown_remaining
        }

        // --- SOIL ---
        if (d.soil_adc !== undefined) {
          document.getElementById('soilADC').textContent = d.soil_adc
          let percent = Math.min(100, Math.round((d.soil_adc / 1023) * 100))
          let fill = document.getElementById('soilProgress')
          fill.style.width = percent + '%'
          fill.textContent = percent + '%'

          const soilStat = document.getElementById('soilStatus')
          if (d.soil_dry === 'YES') {
            soilStat.textContent = 'DRY'
            soilStat.className = 'status-indicator status-no'
          } else {
            soilStat.textContent = 'WET'
            soilStat.className = 'status-indicator status-yes'
          }
        }

        // --- WATER ---
        if (d.water_adc !== undefined) {
          document.getElementById('waterADC').textContent = d.water_adc
          let percent = Math.min(100, Math.round((d.water_adc / 1023) * 100))
          let fill = document.getElementById('waterProgress')
          fill.style.width = percent + '%'
          fill.textContent = percent + '%'

          const waterStat = document.getElementById('waterStatus')
          if (d.water_ok === 'YES') {
            waterStat.textContent = 'OK'
            waterStat.className = 'status-indicator status-yes'
          } else {
            waterStat.textContent = 'LOW'
            waterStat.className = 'status-indicator status-no'
          }
        }

        // --- RAIN ---
        if (d.rain_adc !== undefined) {
          document.getElementById('rainADC').textContent = d.rain_adc
          let percent = Math.min(100, Math.round((d.rain_adc / 1023) * 100))
          let fill = document.getElementById('rainProgress')
          fill.style.width = percent + '%'
          fill.textContent = percent + '%'

          const rainStat = document.getElementById('rainStatus')
          if (d.raining === 'YES') {
            rainStat.textContent = 'RAINING'
            rainStat.className = 'status-indicator status-on'
          } else {
            rainStat.textContent = 'NO RAIN'
            rainStat.className = 'status-indicator status-no'
          }
        }

        // --- PUMP ---
        const pumpEl = document.getElementById('pumpStatus')
        const pumpInd = document.getElementById('pumpIndicator')
        if (d.pump === 'ON') {
          pumpEl.textContent = '‚ö° ON'
          pumpInd.textContent = 'ON'
          pumpInd.className = 'status-indicator status-on'
        } else {
          pumpEl.textContent = '‚≠ï OFF'
          pumpInd.textContent = 'OFF'
          pumpInd.className = 'status-indicator status-off'
        }

        // --- REFILL ---
        const refEl = document.getElementById('refillStatus')
        const refInd = document.getElementById('refillIndicator')
        if (d.refill === 'STARTED') {
          refEl.textContent = 'üö∞ ACTIVE'
          refInd.textContent = 'ACTIVE'
          refInd.className = 'status-indicator status-on'
        } else {
          refEl.textContent = 'üîí STOPPED'
          refInd.textContent = 'STOPPED'
          refInd.className = 'status-indicator status-off'
        }
        //----------------------------------------------------
        // ANALYTICS ‚Äî IMPROVED UI
        //----------------------------------------------------
        const nowSec = Math.floor(Date.now() / 1000)

        // --- Soil ---
        // --- Soil (REVERSED LOGIC: Higher ADC = More Dry) ---
        if (d.soil_adc !== undefined) {
          let soilPct = Math.round((d.soil_adc / 1023) * 100) // 0 = wet, 100 = dry

          let soilStatus =
            soilPct < 30
              ? 'üåßÔ∏è Wet'
              : soilPct < 55
              ? 'üëå Moist'
              : soilPct < 75
              ? '‚ö†Ô∏è Drying'
              : 'üî• Dry'

          let badge =
            soilPct < 30
              ? 'badge-good'
              : soilPct < 55
              ? 'badge-info'
              : soilPct < 75
              ? 'badge-warning'
              : 'badge-danger'

          document.getElementById('analyticsSoil').textContent =
            soilPct + '% Dry'
          document.getElementById('analyticsSoilStatus').textContent =
            soilStatus
          document.getElementById('analyticsSoilStatus').className =
            'analytics-status ' + badge
        }

        // --- Water Tank ---
        if (d.water_adc !== undefined) {
          let waterPct = Math.round((d.water_adc / 1023) * 100)
          let waterStatus =
            waterPct < 20
              ? 'üö® Critical'
              : waterPct < 50
              ? '‚ö†Ô∏è Low'
              : waterPct < 80
              ? 'üëå Good'
              : 'üíß Full'

          let badge =
            waterPct < 20
              ? 'badge-danger'
              : waterPct < 50
              ? 'badge-warning'
              : 'badge-good'

          document.getElementById('analyticsWater').textContent = waterPct + '%'
          document.getElementById('analyticsWaterStatus').textContent =
            waterStatus
          document.getElementById('analyticsWaterStatus').className =
            'analytics-status ' + badge
        }

        // --- Rain ---
        if (d.rain_adc !== undefined) {
          let rainStrength = 100 - Math.round((d.rain_adc / 1023) * 100)
          let rainStatus =
            rainStrength < 10
              ? '‚òÄÔ∏è Clear'
              : rainStrength < 30
              ? '‚õÖ Light Moisture'
              : rainStrength < 60
              ? 'üå¶Ô∏è Possible Rain'
              : 'üåßÔ∏è Heavy Rain'

          let badge =
            rainStrength < 30
              ? 'badge-good'
              : rainStrength < 60
              ? 'badge-warning'
              : 'badge-info'

          document.getElementById('analyticsRain').textContent =
            rainStrength + '%'
          document.getElementById('analyticsRainStatus').textContent =
            rainStatus
          document.getElementById('analyticsRainStatus').className =
            'analytics-status ' + badge
        }

        // --- Pump ---
        let pumpRunning = d.pump === 'ON'
        document.getElementById('analyticsPumpUsage').textContent = pumpRunning
          ? 'ON'
          : 'OFF'

        document.getElementById('analyticsPumpStatus').textContent = pumpRunning
          ? 'Running'
          : 'Stopped'

        document.getElementById('analyticsPumpStatus').className =
          'analytics-status ' + (pumpRunning ? 'badge-info' : 'badge-danger')

        // --- MODE BUTTONS ---
        updateButtons(d.mode || 'AUTO')

        // --- TIMESTAMP ---
        let now = new Date().toLocaleString()
        document.getElementById('lastUpdate').textContent =
          'Last updated: ' + now
      })

      //----------------------------------------------------
      // SET MODE (WRITE TO FIREBASE)
      //----------------------------------------------------
      function setPumpMode(m) {
        ref.update({ mode: m })
        updateButtons(m)
      }

      //----------------------------------------------------
      // UPDATE BUTTON UI
      //----------------------------------------------------
      function updateButtons(m) {
        document.getElementById('btnAuto').classList.remove('active')
        document.getElementById('btnOn').classList.remove('active')
        document.getElementById('btnOff').classList.remove('active')

        if (m === 'AUTO')
          document.getElementById('btnAuto').classList.add('active')
        if (m === 'FORCE_ON')
          document.getElementById('btnOn').classList.add('active')
        if (m === 'FORCE_OFF')
          document.getElementById('btnOff').classList.add('active')
      }
    </script>
  </body>
</html>
